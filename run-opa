#!/usr/bin/env zsh
#
# Created by M. Massenzio, 2022-06-10
set -eu
source ${UTILS_DIR}/utils

###################################################################
######## WARNING -- THIS FILE IS GOING AWAY -- DO NOT EDIT ########
###################################################################


function usage() {
echo "Usage: run-opa BUNDLE

Runs the OPA Server as a docker container, restarting it if it's already running.

  BUNDLE   the path (absolute or relative) to the policies bundle

The BUNDLE can be generated with the 'bundle' script, see usage there."
}

declare -r base=$(dirname $0)
declare policies=${1:-}
declare -r bundle=/etc/opa/bundles/$(basename ${policies})
declare -r opa_version=0.48.0
declare -r port=8181

if [[ ! -f ${policies} ]]
then
  usage
  fatal "Bundle ${policies} must be defined and be a valid policy bundle"
fi


opa_id=$(docker ps --filter "name=opa" --format "{{.ID}}")
if [[ -n ${opa_id} ]]; then
    if read -q "?Restart OPA server to ensure newest bundle is being used? [y/n] "; then
      echo ""
      docker stop -t 0 ${opa_id} >/dev/null
    fi
fi
docker run --rm -d -p ${port}:8181 --name opa \
  -v $(abspath $(dirname ${policies})):$(dirname ${bundle}) \
  openpolicyagent/opa:${opa_version} run --server --addr :8181 ${bundle} >/dev/null

opa_id=$(docker ps --filter "name=opa" --format "{{.ID}}")
msg "Running OPA Server v. ${opa_version}; use: http://localhost:${port}/v1/data for policies"
